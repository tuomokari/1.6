"use strict";$.widget("workdatawidget.workdatawidget",$.core.base,{options:{historyDateKey:""},_create:function(){this._uiState={};this._model={};this._uiState.firstRender=!0;this._firstRefresh=!0},_initWidget:function(){this._model.currentUserId=$("body").attr("data-user");this._setupWidgetEvents();this._getPersistedValues();this._model.userClaContract=this.options.userclacontract},_getPersistedValues:function(){this._model.selectedDateKey=sessionStorage.getItem(this._model.currentUserId+this.element.attr("id")+"_selectedday");this._model.selectedDateKey||(this._model.selectedDateKey=this.getKeyFromDate(new Date));this._model.defaultProject=sessionStorage.getItem(this._model.currentUserId+"_defaultproject");this.options.lastnewid&&this.options.lastnewid!=sessionStorage.getItem(this._model.currentUserId+"_lastnewid")&&this.options.lastnewcollectionname&&(sessionStorage.setItem(this._model.currentUserId+"_lastnewid",this.options.lastnewid),sessionStorage.setItem(this._model.currentUserId+"lastnewcollectionname",this.options.lastnewcollectionname),this._model.lastShownNewId=sessionStorage.getItem($("body").attr("data-user")+"_lastnewid"),this._model.lastShownNewCollection=sessionStorage.getItem($("body").attr("data-user")+"lastnewcollectionname"))},_setupWidgetEvents:function(){var n=this},refreshData:function(n){var t=this,r;if(n||(n={}),n.startDate&&n.endDate)this._model.startDate=n.startDate,this._model.endDate=n.endDate;else if(!this._model.startDate&&!this._model.endDate)return;this._model.days={};this._generateDaysForRange();this._determineNextAndPreviousDay();this._firstRefresh||(this._model.lastShownNewId=null,this._model.lastShownNewCollection=null,this._model.lastShownNewDocument=null,this._model.lastShownNewDocumentDateKey=null);var i=[],f=$("body").data("user"),u=restApi.find("workdatawidget","entrydata",{user:new ObjectId(f),start:t._model.startDate,end:t._model.endDate});u.done(function(n){t._model.timesheetEntries=[];t._model.absenceEntries=[];t._model.dayEntries=[];t._model.assetEntries=[];t._model.allocationEntries=[];t._model.articleEntries=[];n.timesheetentry&&(t._model.timesheetEntries=n.timesheetentry);n.absenceentry&&(t._model.absenceEntries=n.absenceentry);n.dayentry&&(t._model.dayEntries=n.dayentry);n.articleentry&&(t._model.articleEntries=n.articleentry);n.allocationentry&&(t._model.allocationEntries=n.allocationentry,t._model.allocationEntries.sort(t._endtimeSortFunction));n.assetentry&&(t._model.assetEntries=n.assetentry);t._model.timesheetEntriesById={};t._model.absenceEntriesById={};t._model.dayEntriesById={};t._model.assetEntriesById={};t._model.allocationEntriesById={};t._model.articleEntriesById={};t._addEntriesFromArrayToObject(t._model.timesheetEntries,t._model.timesheetEntriesById);t._addEntriesFromArrayToObject(t._model.absenceEntries,t._model.absenceEntriesById);t._addEntriesFromArrayToObject(t._model.dayEntries,t._model.dayEntriesById);t._addEntriesFromArrayToObject(t._model.assetEntries,t._model.assetEntriesById);t._addEntriesFromArrayToObject(t._model.allocationEntries,t._model.allocationEntriesById);t._addEntriesFromArrayToObject(t._model.articleEntries,t._model.articleEntriesById)});r=restApi.find("workdatawidget","paytypes");r.done(function(n){var i,r;if(!n.timesheetentrydetailpaytype)throw"No paytypes found";for(t._model.payTypes=n.timesheetentrydetailpaytype,t._model.payTypesById={},i=0;i<t._model.payTypes.length;i++)r=t._model.payTypes[i],t._model.payTypesById[r._id]=r;for(t._model.dayEntryTypes=n.dayentrytype,t._model.dayEntryTypesById={},i=0;i<t._model.dayEntryTypes.length;i++)r=t._model.dayEntryTypes[i],t._model.dayEntryTypesById[r._id]=r});i.push(u);i.push(r);$.when.apply($,i).done(function(){t._cacheDataById();t._convertWorkDataDates();t._splitWorkDataToDays();t._addTimedEntries();t._splitAssetDataForAssets();t._countDailyTotals();t._sortEntries();t._findEntryToHighlight();$(t.element).trigger("datarefreshed");t._firstRefresh=!1})},_addEntriesFromArrayToObject:function(n,t){for(var r,i=0;i<n.length;i++)(r=n[i],r._id)&&(t[r._id]=r)},_determineNextAndPreviousDay:function(){var n=this.getDateFromKey(this._model.selectedDateKey),t=this.getKeyFromDate(new moment(n).add(1,"days").toDate()),i=this.getKeyFromDate(new moment(n).add(-1,"days").toDate());this._model.nextDateKey=this._model.days[t]?t:null;this._model.prevDateKey=this._model.days[i]?i:null},_cacheDataById:function(){this._cacheCollectionById("allocationEntries")},_cacheCollectionById:function(n){var r=this._model[n],u={},t,i;for(this._model[n+"ById"]=u,t=0;t<r.length;t++)i=r[t],u[i._id]=i},setCurrentDateAsCopied:function(){this._model.copiedDateKey=this._model.selectedDateKey},setSelectedDate:function(n){this.setSelectedDateKey(getKeyFromDate(n))},setSelectedDateKey:function(n){this._model.selectedDateKey=n;sessionStorage.setItem($("body").attr("data-user")+this.element.attr("id")+"_selectedday",n);this._determineNextAndPreviousDay();$(this.element).trigger("selecteddatechanged",n)},scrollHorizontalWorkView:function(){$(this.element).trigger("scrollrequest")},getKeyFromDate:function(n){var r=n.getFullYear().toString(),t=(n.getMonth()+1).toString(),i=n.getDate().toString();return r+(t[1]?t:"0"+t[0])+(i[1]?i:"0"+i[0])},getDateFromKey:function(n){var t=parseInt(n.substr(0,4)),i=parseInt(n.substr(4,2)),r=parseInt(n.substr(6,2));return new Date(t,i-1,r)},startProject:function(n){this._model.allocationEntriesById[n].status="In progress";$(this.element).trigger("datarefreshed")},endProject:function(n){this._model.allocationEntriesById[n].status="Done";$(this.element).trigger("datarefreshed")},_convertWorkDataDates:function(){var n=this;n._convertDates(n._model.timesheetEntries);n._convertDates(n._model.absenceEntries);n._convertDates(n._model.dayEntries);n._convertDates(n._model.assetEntries);n._convertDates(n._model.articleEntries);n._convertDates(n._model.allocationEntries)},_convertDates:function(n){for(var t,i=0;i<n.length;i++)t=n[i],t.date&&(t.date=getDateFromIsoString(t.date)),t.starttimestamp&&(t.starttimestamp=getDateFromIsoString(t.starttimestamp)),t.endtimestamp&&(t.endtimestamp=getDateFromIsoString(t.endtimestamp)),t.created&&(t.created=getDateFromIsoString(t.created))},_generateDaysForRange:function(){for(var i=this,t=moment(i._model.startDate),r=moment(i._model.endDate),u=this.getKeyFromDate(new Date),n;t.diff(r)<=0;)t=t.add(1,"days"),n={},n.date=new Date(t.toDate().getTime()),n.totalWorkHours=0,n.totalAbsenceHours=0,n.totalAllHours=0,n.overtime50Hours=0,n.overtime100Hours=0,n.overtime150Hours=0,n.overtime200Hours=0,n.timesheetEntries=[],n.allocationEntries=[],n.absenceEntries=[],n.timedEntries=[],n.dayEntries=[],n.articleEntries=[],n.assetEntries=[],n.projects=[],n.projectsObject={},n.extras=[],n.extrasById={},n.key=i.getKeyFromDate(t.toDate()),n.hasUnapprovedEntries=!1,n.hasUnapprovedCurrentUserCreatedEntries=!1,n.hasEntries=!1,n.assets=[],n.assetsById={},n.key===u&&(n.isToday=!0),i._model.days[n.key]=n},_splitWorkDataToDays:function(){this._splitDataWithDatesToDays(this._model.timesheetEntries,"timesheetEntries");this._splitDataWithDatesToDays(this._model.absenceEntries,"absenceEntries");this._splitDataWithDatesToDays(this._model.dayEntries,"dayEntries");this._splitDataWithDatesToDays(this._model.articleEntries,"articleEntries");this._splitDataWithDatesToDays(this._model.assetEntries,"assetEntries");this._splitDataWithDatesToDays(this._model.allocationEntries,"allocationEntries")},_splitDataWithDatesToDays:function(n,t){for(var r,u,f,i=0;i<n.length;i++)(r=n[i],r.date)&&(u=this.getKeyFromDate(r.date),f=this._model.days[u],f[t].push(r))},_addTimedEntries:function(){for(var t,n,r=this._getDaysArray(),i=0;i<r.length;i++){for(t=r[i],n=0;n<t.timesheetEntries.length;n++)t.timedEntries.push(t.timesheetEntries[n]);for(n=0;n<t.absenceEntries.length;n++)t.timedEntries.push(t.absenceEntries[n])}},_splitAssetDataForAssets:function(){for(var t,r,i,n,f=this._getDaysArray(),u=0;u<f.length;u++){for(t=f[u],i=0;i<t.assetEntries.length;i++)(r=t.assetEntries[i],r.asset)&&(t.assetsById[r.asset._id]||(n={},n.totalHours=0,n._id=r.asset._id,n.__displayname=r.asset.__displayname,n.hours=[],t.assetsById[r.asset._id]=n,t.assets.push(n)),n=t.assetsById[r.asset._id],n.hours.push(r));for(i=0;i<t.assets.length;i++)n=t.assets[i],n.hours.sort(this._timestampSortFunction)}},_sortEntries:function(){for(var t,i=this._getDaysArray(),n=0;n<i.length;n++)t=i[n],this._sortTimedEntries(t),this._sortAllocations(t)},_findEntryToHighlight:function(){this._model.lastShownNewCollection=="timesheetentry"?this._model.lastShownNewDocument=this._model.timesheetEntriesById[this._model.lastShownNewId]:this._model.lastShownNewCollection=="dayentry"?this._model.lastShownNewDocument=this._model.dayEntriesById[this._model.lastShownNewId]:this._model.lastShownNewCollection=="articleentry"?this._model.lastShownNewDocument=this._model.articleEntriesById[this._model.lastShownNewId]:this._model.lastShownNewCollection=="absenceentry"?this._model.lastShownNewDocument=this._model.absenceEntriesById[this._model.lastShownNewId]:this._model.lastShownNewCollection=="assetentry"&&(this._model.lastShownNewDocument=this._model.assetEntriesById[this._model.lastShownNewId]);this._model.lastShownNewDocument&&(this._model.lastShownNewDocumentDateKey=this.getKeyFromDate(this._model.lastShownNewDocument.date))},_timestampSortFunction:function(n,t){return!n.starttimestamp&&!t.starttimestamp?0:n.starttimestamp?t.starttimestamp?n.starttimestamp==t.starttimestamp?0:n.starttimestamp<t.starttimestamp?-1:1:1:-1},_endtimeSortFunction:function(n,t){if(n.endtimestamp)if(t.endtimestamp){if(n.endtimestamp!=t.endtimestamp)return n.endtimestamp<t.endtimestamp?-1:1}else return-1;else if(t.endtimestamp)return 1;return!n.project.__displayname&&!t.project.__displayname?0:n.project.__displayname?t.project.__displayname?n.project.__displayname==t.project.__displayname?0:n.project.__displayname<t.project.__displayname?-1:1:1:-1},_sortTimedEntries:function(n){n.timedEntries.sort(this._timestampSortFunction)},_sortAllocations:function(n){n.allocationEntries.sort(this._timestampSortFunction)},_countDailyTotals:function(){for(var n,f,e,a,o,s,h,r,t,c,i,u,v=this._getDaysArray(),l=0;l<v.length;l++){for(n=v[l],t=0;t<n.timesheetEntries.length;t++){if(n.hasEntries=!0,f=n.timesheetEntries[t],!f.timesheetentrydetailpaytype){console.log("Paytype missing from TSE "+f._id);continue}r=this._millisecondsToHours(f.duration);i=this._model.payTypesById[f.timesheetentrydetailpaytype._id];features.timetracking?f.parent||(n.totalWorkHours+=r,n.totalAllHours+=r):i.countsasregularhours&&(n.totalWorkHours+=r,n.totalAllHours+=r);i.isovertime50?n.overtime50Hours+=r:i.isovertime100?n.overtime100Hours+=r:i.isovertime150?n.overtime150Hours+=r:i.isovertime200&&(n.overtime200Hours+=r);i.icon?(u="[icon]"+i.icon,n.extrasById[u]||u=="[icon]schedule"||(n.extras.push(u),n.extrasById[u]=!0)):i.abbreviation&&(n.extrasById[i.abbreviation]||(n.extras.push(i.abbreviation),n.extrasById[i.abbreviation]=!0));f.approvedbyworker?n.hasApprovedEntries=!0:(n.hasUnapprovedEntries=!0,f.creator._id==this._model.currentUserId&&(n.hasUnapprovedCurrentUserCreatedEntries=!0))}for(t=0;t<n.absenceEntries.length;t++)n.hasEntries=!0,e=n.absenceEntries[t],r=this._millisecondsToHours(e.duration),n.totalAllHours+=r,n.totalAbsenceHours+=r,e.approvedbyworker?n.hasApprovedEntries=!0:(n.hasUnapprovedEntries=!0,e.creator._id==this._model.currentUserId&&(n.hasUnapprovedCurrentUserCreatedEntries=!0));for(t=0;t<n.articleEntries.length;t++)n.hasEntries=!0,a=n.articleEntries[t],a.approvedbyworker?n.hasApprovedEntries=!0:(n.hasUnapprovedEntries=!0,a.creator._id==this._model.currentUserId&&(n.hasUnapprovedCurrentUserCreatedEntries=!0));for(t=0;t<n.assets.length;t++)for(n.hasEntries=!0,o=n.assets[t],s=0;s<o.hours.length;s++)h=o.hours[s],r=this._millisecondsToHours(h.duration),o.totalHours+=r,h.approvedbyworker?n.hasApprovedEntries=!0:(n.hasUnapprovedEntries=!0,h.creator._id==this._model.currentUserId&&(n.hasUnapprovedCurrentUserCreatedEntries=!0));for(t=0;t<n.dayEntries.length;t++)n.hasEntries=!0,c=n.dayEntries[t],c.approvedbyworker?n.hasApprovedEntries=!0:(n.hasUnapprovedEntries=!0,c.creator._id==this._model.currentUserId&&(n.hasUnapprovedCurrentUserCreatedEntries=!0)),i=this._model.dayEntryTypesById[c.dayentrytype._id],i.icon?(u="[icon]"+i.icon,n.extrasById[u]||(n.extras.push(u),n.extrasById[u]=!0)):i.abbreviation&&(n.extrasById[i.abbreviation]||(n.extras.push(i.abbreviation),n.extrasById[i.abbreviation]=!0))}},_splitEntriesForProjects:function(n){for(var n,i,r,u,t,f,o=this._getDaysArray(),e=0;e<o.length;e++){for(n=o[e],t=0;t<n.timesheetEntries.length;t++)(i=n.timesheetEntries[t],i.project)&&(this._verifyProjectExists(n,i.project._id),n.projectsObject[i.project._id].timesheetEntries.push(i));for(t=0;t<n.dayEntries.length;t++)r=n.dayEntries[t],this._verifyProjectExists(n,r.project._id),n.projectsObject[r.project._id].dayEntries.push(r);for(t=0;t<n.articleEntries.length;t++)u=n.articleEntries[t],this._verifyProjectExists(n,u.project._id),n.projectsObject[u.project._id].articleEntries.push(u);for(t=0;t<n.assetEntries.length;t++)f=n.assetEntries[t],this._verifyProjectExists(n,f.project._id),n.projectsObject[f.project._id].assetEntries.push(f)}},_verifyProjectExists:function(n,t){if(!n.projectsObject[t]){var i={};i.timesheetEntries=[];i.dayEntries=[];i.articleEntries=[];i.assetEntries=[];n.projectsObject[t]=i;n.projects.push(i)}},render:function(n){n||(n={});this._uiState.firstRender&&(this.element.removeClass("__hidden"),this._uiState.firstRender=!1)},_getDaysArray:function(){for(var n=this,t=moment(n._model.startDate),u=moment(n._model.endDate),i=[],r;t.diff(u)<=0;)currentDay=t.add("days",1),r=n._model.days[n.getKeyFromDate(currentDay.toDate())],i.push(r);return i},_millisecondsToHours:function(n){return n?n/36e5:0}});